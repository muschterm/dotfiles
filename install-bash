#!/usr/bin/env bash

cat <<- HERE
-------------------------------------------------------------------------------
Installing dotfiles!
-------------------------------------------------------------------------------

HERE

if [ -z "$BASH_VERSION" ] || [ ! -n "$BASH_VERSION" ]; then
	cat <<- HERE
	Bash is required!
	HERE

	exit
fi

# if MacOS, Homebrew is required for this script to work 100%
if [ "$(uname -s)" = "Darwin" ]; then
	if command -v brew > /dev/null; then

		# GNU coreutils
		PATH="$(brew --prefix)/opt/coreutils/libexec/gnubin:$PATH"
		MANPATH="$(brew --prefix)/opt/coreutils/libexec/gnuman:$MANPATH"
		if [ ! -d "$(brew --prefix)/opt/coreutils/libexec/gnubin" ]; then
			cat <<- HERE
			Homebrew 'coreutils' not installed!

			HERE

			brew install coreutils

			cat <<- HERE
			Homebrew 'coreutils' installed!

			HERE
		fi

	else
		cat <<- HERE
		Homebrew is required for this script to work!
		HERE

		exit
	fi
fi

dotfiles_dir="$( cd $(dirname "$(readlink -f -- "$0" )" ) && pwd )"

# ln -snf "$dotfiles_dir/bin" "$HOME/bin"

if [ ! -z $DOCKER_IMAGE_NAME ]; then
	ln -snf "$dotfiles_dir/init" "/etc/profile.d/init"
elif [ "$(uname -s)" = "Linux" ] || [ "$(uname -s)" = "Darwin" ]; then

	if [ ! -f "$HOME/.profile" ]; then
		cat <<- HERE
		Creating "$HOME/.profile"!
		HERE

		touch "$HOME/.profile"
	fi

	if [ -f "$HOME/.bash_profile" ]; then
		mv "$HOME/.bash_profile" "$HOME/.bash_profile.bak"
	fi

	if [ -f "$HOME/.bash_login" ]; then
		mv "$HOME/.bash_login" "$HOME/.bash_login.bak"
	fi

	profile_begin_line="$(grep -n "BEGIN: autogenerated from dotfiles.git/install" "$HOME/.profile" | awk -F ":" '{print $1}')"
	profile_end_line="$(grep -n "END: autogenerated from dotfiles.git/install" "$HOME/.profile" | awk -F ":" '{print $1}')"

	if [ ! -z "$profile_begin_line" ]; then
		# delete old lines in .profile
		mv "$HOME/.profile" "$HOME/.profile.bak"
		sed "${profile_begin_line},${profile_end_line}d" "$HOME/.profile.bak" > "$HOME/.profile"
	fi

	cat <<- HERE >> "$HOME/.profile"
	# BEGIN: autogenerated from dotfiles.git/install-bash                          #
	################################################################################

	# set PATH so it includes user's private bin if it exists
	[ -d "\$HOME/bin" ] && export PATH="\$HOME/bin:\$PATH"
	[ -d "\$HOME/.local/bin" ] && export PATH="\$HOME/.local/bin:\$PATH"

	# if running bash
	[ -n "\$BASH_VERSION" ] && [ -f "\$HOME/.bashrc" ] && . "\$HOME/.bashrc"

	################################################################################
	# END: autogenerated from dotfiles.git/install-bash                            #
	HERE

	if [ ! -f "$HOME/.bashrc" ]; then
		touch "$HOME/.bashrc"
	fi

	bashrc_begin_line="$(grep -n "BEGIN: autogenerated from dotfiles.git/install" "$HOME/.bashrc" | awk -F ":" '{print $1}')"
	bashrc_end_line="$(grep -n "END: autogenerated from dotfiles.git/install" "$HOME/.bashrc" | awk -F ":" '{print $1}')"

	if [ ! -z "$bashrc_begin_line" ]; then
		# delete old lines in .bashrc
		mv "$HOME/.bashrc" "$HOME/.bashrc.bak"
		sed "${bashrc_begin_line},${bashrc_end_line}d" "$HOME/.bashrc.bak" > "$HOME/.bashrc"
	fi

	cat <<- HERE >> "$HOME/.bashrc"
	# BEGIN: autogenerated from dotfiles.git/install-bash                          #
	################################################################################

	export DOTFILES_DIR="$dotfiles_dir"
	[ -f "\$DOTFILES_DIR/init" ] && . "\$DOTFILES_DIR/init"

	################################################################################
	# END: autogenerated from dotfiles.git/install-bash                            #
	HERE

	if [ "$(uname -s)" = "Linux" ]; then
		cat <<- HERE
		"$HOME/.profile" and "$HOME/.bashrc" have been updated!
		Please log out and log back in for changes to take affect.
		HERE
	else
		# Non-Linux OS's handle .profile during shell startup rather than a real user 
		# login. Any new terminal windows will automatically source the user's updated 
		# .profile. Ensure the current terminal window has the .profile sourced.

		cat <<- HERE
		"$HOME/.profile" and "$HOME/.bashrc" have been updated!
		Please close and open a new terminal window for changes to take affect.
		HERE
	fi
fi

cat <<- HERE

-------------------------------------------------------------------------------
Finished!
-------------------------------------------------------------------------------
HERE


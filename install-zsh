#!/usr/bin/env zsh

cat <<- HERE
-------------------------------------------------------------------------------
Installing dotfiles!
-------------------------------------------------------------------------------

HERE

if [ -z "$ZSH_VERSION" ] || [ ! -n "$ZSH_VERSION" ]; then
	cat <<- HERE
	zsh is required!
	HERE

	exit
fi

dotfiles_dir="${0:a:h}"

# ln -snf "$dotfiles_dir/bin" "$HOME/bin"

if [ ! -z $DOCKER_IMAGE_NAME ]; then
	ln -snf "$dotfiles_dir/init" "/etc/profile.d/init"
elif [ "$(uname -s)" = "Linux" ] || [ "$(uname -s)" = "Darwin" ]; then

	if [ ! -f "$HOME/.zprofile" ]; then
		touch "$HOME/.zprofile"
	fi

	zprofile_begin_line="$(grep -n "BEGIN: autogenerated from dotfiles.git/install-zsh" "$HOME/.zprofile" | awk -F ":" '{print $1}')"
	zprofile_end_line="$(grep -n "END: autogenerated from dotfiles.git/install-zsh" "$HOME/.zprofile" | awk -F ":" '{print $1}')"

	if [ ! -z "$zprofile_begin_line" ]; then
		# delete old lines in .zprofile
		mv "$HOME/.zprofile" "$HOME/.zprofile.bak"
		sed "${zprofile_begin_line},${zprofile_end_line}d" "$HOME/.zprofile.bak" > "$HOME/.zprofile"
	fi
	
	cat <<- HERE >> "$HOME/.zprofile"
	# BEGIN: autogenerated from dotfiles.git/install-zsh                           #
	################################################################################

	# set PATH so it includes user's private bin if it exists
	[ -d "\$HOME/bin" ] && export PATH="\$HOME/bin:\$PATH"
	[ -d "\$HOME/.local/bin" ] && export PATH="\$HOME/.local/bin:\$PATH"

	################################################################################
	# END: autogenerated from dotfiles.git/install-zsh                             #
	HERE

	if [ ! -f "$HOME/.zshrc" ]; then
		touch "$HOME/.zshrc"
	fi

	zshrc_begin_line="$(grep -n "BEGIN: autogenerated from dotfiles.git/install-zsh" "$HOME/.zshrc" | awk -F ":" '{print $1}')"
	zshrc_end_line="$(grep -n "END: autogenerated from dotfiles.git/install-zsh" "$HOME/.zshrc" | awk -F ":" '{print $1}')"

	if [ ! -z "$zshrc_begin_line" ]; then
		# delete old lines in .zshrc
		mv "$HOME/.zshrc" "$HOME/.zshrc.bak"
		sed "${zshrc_begin_line},${zshrc_end_line}d" "$HOME/.zshrc.bak" > "$HOME/.zshrc"
	fi

	cat <<- HERE >> "$HOME/.zshrc"
	# BEGIN: autogenerated from dotfiles.git/install-zsh                           #
	################################################################################

	export DOTFILES_DIR="$dotfiles_dir"
	[ -f "\$DOTFILES_DIR/init" ] && . "\$DOTFILES_DIR/init"

	################################################################################
	# END: autogenerated from dotfiles.git/install-zsh                             #
	HERE

	if [ "$(uname -s)" = "Linux" ]; then
		cat <<- HERE
		"$HOME/.zprofile" and "$HOME/.zshrc" have been updated!
		Please log out and log back in for changes to take affect.
		HERE
	else
		# Non-Linux OS's handle .profile during shell startup rather than a real user 
		# login. Any new terminal windows will automatically source the user's updated 
		# .profile. Ensure the current terminal window has the .profile sourced.

		cat <<- HERE
		"$HOME/.zprofile" and "$HOME/.zshrc" have been updated!
		Please close and open a new terminal window for changes to take affect.
		HERE
	fi
fi

cat <<- HERE

-------------------------------------------------------------------------------
Finished!
-------------------------------------------------------------------------------
HERE

